<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Team Gantt Board</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }

        h1 {
            color: #2c3e50;
            margin-bottom: 20px;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        button {
            padding: 8px 16px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
        }

        button:hover {
            background: #2980b9;
        }

        button:disabled {
            background: #95a5a6;
            cursor: not-allowed;
        }

        button.delete {
            background: #e74c3c;
        }

        button.delete:hover {
            background: #c0392b;
        }

        input, select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .gantt-container {
            overflow-x: auto;
            margin-bottom: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            position: relative;
        }

        .gantt-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1200px;
        }

        .gantt-table th, .gantt-table td {
            border: 1px solid #e0e0e0;
            min-height: 50px;
            position: relative;
            vertical-align: top;
        }

        .gantt-table th {
            background: #f8f9fa;
            font-weight: 600;
            font-size: 12px;
            padding: 8px;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .gantt-table th:first-child {
            width: 150px;
            position: sticky;
            left: 0;
            z-index: 11;
            background: #e8eaed;
        }

        .gantt-table td:first-child {
            font-weight: 500;
            padding: 8px;
            background: #f8f9fa;
            position: sticky;
            left: 0;
            z-index: 9;
        }

        .week-cell {
            min-width: 60px;
            position: relative;
            user-select: none;
            padding: 2px;
            vertical-align: top;
        }

        .week-cell.highlight {
            background: #fff3cd !important;
        }

        .week-cell-stack {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .task-block {
            position: absolute;
            border-radius: 4px;
            padding: 2px 6px;
            color: white;
            font-size: 10px;
            cursor: move;
            display: flex;
            align-items: center;
            justify-content: space-between;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            min-height: 10px;
            z-index: 5;
        }

        .task-block.single-week {
            cursor: grab;
        }

        .partial {
            opacity: 0.7;
            background-image: repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(255, 255, 255, .1) 10px, rgba(255, 255, 255, .1) 20px);
        }

        .task-name {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 9px;
        }

        .task-info {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 9px;
            opacity: 0.9;
        }

        .resize-handle {
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: 10px;
            cursor: ew-resize;
            background: rgba(0, 0, 0, 0.2);
            opacity: 1;
            transition: opacity 0.2s;
        }

        .task-block:hover .resize-handle {
            opacity: 1;
        }

        .dragging {
            opacity: 0.5;
        }

        .week-cell.drag-over {
            background: #e3f2fd;
        }

        .resizing {
            opacity: 0.7;
            pointer-events: none;
        }

        .resize-preview {
            position: absolute;
            top: 2px;
            border-radius: 4px;
            border: 2px dashed rgba(0, 0, 0, 0.3);
            background: rgba(52, 152, 219, 0.3);
            min-height: 20px;
            opacity: 0.7;
            pointer-events: none;
            z-index: 2;
        }

        .sidebar {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .panel {
            flex: 1;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
        }

        .panel h3 {
            margin-bottom: 10px;
            color: #34495e;
            font-size: 14px;
        }

        .task-block.excluded {
            opacity: 0.7;
            border: 2px dashed rgba(199, 39, 39, 0.8);
        }

        .task-template {
            background: white;
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 6px;
            cursor: move;
            border: 2px solid transparent;
            transition: all 0.2s;
            position: relative;
        }

        .task-template:hover {
            border-color: #3498db;
            transform: translateX(2px);
        }

        .task-template.dragging {
            opacity: 0.5;
        }

        .task-template-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .task-template-name {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .task-template-info {
            font-size: 12px;
            color: #666;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .task-template-info input {
            width: 40px;
            padding: 2px 4px;
            font-size: 11px;
        }

        .task-template-actions {
            display: flex;
            gap: 10px;
            margin-top: 8px;
        }

        .task-template-actions button {
            padding: 4px 8px;
            font-size: 11px;
        }

        .week-blocks {
            display: flex;
            gap: 4px;
            margin-top: 8px;
            flex-wrap: wrap;
        }

        .week-block {
            background: #3498db;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            cursor: grab;
            transition: transform 0.2s;
        }

        .week-block:hover {
            transform: scale(1.1);
        }

        .week-block.dragging {
            opacity: 0.5;
        }

        .week-block.used {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .summary {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .summary h3 {
            margin-bottom: 10px;
            color: #2c3e50;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .summary-item {
            background: white;
            padding: 10px;
            border-radius: 6px;
            border-left: 4px solid #3498db;
        }

        .summary-item.warning {
            border-left-color: #f39c12;
        }

        .summary-item.error {
            border-left-color: #e74c3c;
        }

        .person-capacity {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            margin-bottom: 4px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 8px;
            min-width: 400px;
            max-width: 600px;
        }

        .modal-content h3 {
            margin-bottom: 15px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
            font-weight: 500;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 8px;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .task-colors {
            display: flex;
            gap: 5px;
            margin-top: 10px;
        }

        .color-option {
            width: 30px;
            height: 30px;
            border-radius: 4px;
            cursor: pointer;
            border: 2px solid transparent;
        }

        .color-option.selected {
            border-color: #333;
        }

        .delete-icon {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 20px;
            height: 20px;
            background: #e74c3c;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 12px;
        }

        .mode-toggle {
            display: flex;
            gap: 10px;
            align-items: center;
            background: #f8f9fa;
            padding: 5px;
            border-radius: 6px;
        }

        .mode-toggle label {
            font-size: 14px;
        }

        .weeks-input {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .weeks-input input {
            width: 60px;
        }

        .weeks-input #startDateInput {
            width: 120px;
        }

        /* Context Menu */
        .context-menu {
            position: absolute;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            padding: 4px 0;
            z-index: 1000;
            display: none;
        }

        .context-menu.active {
            display: block;
        }

        .context-menu-item {
            padding: 8px 16px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }

        .context-menu-item:hover {
            background: #f0f0f0;
        }

        .context-menu-item.disabled {
            color: #999;
            cursor: not-allowed;
        }

        .context-menu-item.disabled:hover {
            background: transparent;
        }

        .quick-actions-button {
            width: 100%;
            margin-bottom: 8px;
        / / make buttons with margin display: block;
        }


        button.rename-btn {
            position: absolute;
            top: 5px;
            right: 50px;
            width: 60px;
            height: 20px;
            background: #3882d6;
            color: white;

            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 10px;
        }

        button.rename-btn:hover {
            background: #e67e22;
        }

        #taskTemplates {
            max-height: 400px;
            overflow-y: auto;
            padding-right: 5px; /* Add some padding for scrollbar */
        }

        /* Optional: Style the scrollbar for better appearance */
        #taskTemplates::-webkit-scrollbar {
            width: 6px;
        }

        #taskTemplates::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        #taskTemplates::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }

        #taskTemplates::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>Team Gantt Board</h1>

    <div class="controls">
        <button onclick="addPerson()">Add Person</button>
        <button onclick="addTaskTemplate()">Add Task Template</button>
        <button onclick="saveProject()">Save Project</button>
        <button onclick="loadProject()">Load Project</button>
        <button onclick="clearBoard()">Clear Board</button>
        <button id="undoBtn" onclick="undo()" disabled>Undo</button>
        <button id="redoBtn" onclick="redo()" disabled>Redo</button>
        <input type="file" id="fileInput" style="display: none" onchange="handleFileLoad(event)">
        <div class="weeks-input">
            <label>Weeks:</label>
            <input type="number" id="weeksInput" value="13" min="1" max="52" onchange="changeWeeks()">
        </div>
        <div class="weeks-input">
            <label>Start Date:</label>
            <input type="date" id="startDateInput" onchange="updateStartDate()">
        </div>
        <div class="mode-toggle">
            <label>Mode:</label>
            <select id="modeSelect" onchange="changeMode()" disabled>
                <option value="granular">Granular (Weekly)</option>
            </select>
        </div>
    </div>

    <div class="sidebar">
        <div class="panel">
            <h3>Task Templates</h3>
            <div id="taskTemplates"></div>
        </div>

        <div class="panel">
            <h3>Quick Actions</h3>
            <button onclick="optimizeGantt()" class="quick-actions-button">Optimize Gantt</button>
            <span></span>
            <button onclick="exportToCsv()" class="quick-actions-button">Export CSV</button>
        </div>
    </div>

    <div class="gantt-container">
        <table class="gantt-table" id="ganttTable">
            <thead>
            <tr id="headerRow">
                <th>Team Member</th>
            </tr>
            </thead>
            <tbody id="ganttBody">
            </tbody>
        </table>
    </div>

    <div class="summary">
        <h3>Summary</h3>
        <div class="summary-grid" id="summary"></div>
    </div>
</div>

<div class="modal" id="taskModal">
    <div class="modal-content">
        <h3>Add Task Template</h3>
        <div class="form-group">
            <label>Task Name</label>
            <input type="text" id="taskName" placeholder="e.g., Feature A">
        </div>
        <div class="form-group">
            <label>Duration (weeks)</label>
            <input type="number" id="taskDuration" min="0.5" step="0.5" value="1">
        </div>

        <div class="form-group">
            <label>Category</label>
            <input type="text" id="taskCategory" placeholder="e.g., Development, Design">
        </div>
        <div class="form-group">
            <label>Color</label>
            <div class="task-colors" id="colorPicker"></div>
        </div>
        <div class="form-group">
        <label>
            <input type="checkbox" id="taskExcluded" style="width: auto; margin-right: 8px;">
            Exclude from calculations (treat as non-billable/overhead)
        </label>
        </div>
        <div class="modal-actions">
            <button onclick="closeModal()">Cancel</button>
            <button onclick="saveTaskTemplate()">Save</button>
        </div>
    </div>
</div>

<!-- Context Menu -->
<div class="context-menu" id="contextMenu">
    <div class="context-menu-item" onclick="contextMenuCopy()">Copy</div>
    <div class="context-menu-item" onclick="contextMenuPaste()">Paste</div>
    <div class="context-menu-item" onclick="contextMenuDelete()">Delete</div>
</div>

<!-- Edit Modal -->
<div class="modal" id="renameModal">
    <div class="modal-content">
        <h3>Edit Task Template</h3>
        <div class="form-group">
            <label>Task Name</label>
            <input type="text" id="renameName" placeholder="New task name">
        </div>
        <div class="form-group">
            <label>Category</label>
            <input type="text" id="renameCategory" placeholder="New category">
        </div>
        <div class="form-group">
            <label>Color</label>
            <div class="task-colors" id="colorPickerEdit"></div>
        </div>
        <div class="form-group">
            <label>
                <input type="checkbox" id="renameExcluded" style="width: auto; margin-right: 8px;">
                Exclude from calculations (treat as non-billable/overhead)
            </label>
        </div>
        <div class="form-group" style="background: #fff3cd; padding: 10px; border-radius: 4px; font-size: 13px;">
            <strong>⚠️ Note:</strong> This will update all existing assignments with this task.
        </div>
        <div class="modal-actions">
            <button onclick="closeRenameModal()">Cancel</button>
            <button onclick="confirmEdit()">Save</button>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.5.0/lz-string.min.js"></script>
<script>
    let data = {
        people: ['Yevhen', 'Pylyp', 'Andrii', 'Dzianis', 'Dmytro', 'Ihor', 'Denis'],
        weeks: 13,
        taskTemplates: [
            {id: 1, name: 'Feature A', duration: 3, category: 'Development', color: '#3498db'},
            {id: 2, name: 'Feature B', duration: 2, category: 'Development', color: '#2ecc71'},
            {id: 3, name: 'Jumps', duration: 1, category: 'Jumps', color: '#9b59b6'},
            {id: 4, name: 'EE', duration: 2, category: 'EE', color: '#e67e22'}
        ],
        assignments: [],
        mode: 'granular',
        startDate: null,
    };

    // Undo/Redo history
    let history = [];
    let historyIndex = -1;
    const maxHistorySize = 50;

    // Context menu state
    let contextMenuTarget = null;
    let clipboard = null;

     // generate more colors if needed
    const colors = ['#e74c3c', '#3498db', '#2ecc71', '#f39c12', '#9b59b6', '#1abc9c', '#e67e22', '#c0392b', '#16a085', '#8e44ad', '#2c3e50', '#d35400'];


    let selectedColor = colors[0];
    let selectedEditColor = null;
    let draggedElement = null;
    let draggedData = null;
    let highlightedTask = null;


    function encodeStateToUrl() {
        try {
            const json = JSON.stringify(data);
            const compressed = LZString.compressToEncodedURIComponent(json);
            const url = new URL(window.location.href);
            url.hash = `stateV2=${compressed}`;
            window.history.replaceState(null, '', url.toString())
        } catch (e) {
            console.warn('Failed to encode URL state:', e);
        }
    }

    function decodeStateFromUrl() {
        try {
            const hash = window.location.hash.startsWith('#') ? window.location.hash.slice(1) : window.location.hash;
            const params = new URLSearchParams(hash);

            // Try LZ-String format
            const stateV2 = params.get('stateV2');
            if (stateV2) {
                const json = LZString.decompressFromEncodedURIComponent(stateV2);
                return JSON.parse(json);
            }

            // Fallback to older formats...
            const v1 = params.get('state');
            if (v1) {
                try {
                    const json = decodeURIComponent(atob(v1));
                    return JSON.parse(json);
                } catch {
                    // Handle legacy format that might be double-encoded
                    return null;
                }
            }
            return null;
        } catch (e) {
            console.warn('Failed to decode URL state:', e);
            return null;
        }
    }


    function saveState() {
        // Save current state to history
        const state = JSON.parse(JSON.stringify(data));

        // Remove any states after current index
        history = history.slice(0, historyIndex + 1);

        // Add new state
        history.push(state);

        // Limit history size
        if (history.length > maxHistorySize) {
            history.shift();
        } else {
            historyIndex++;
        }

        localStorage.setItem('ganttBoardData', JSON.stringify(data))
        localStorage.setItem('ganttBoardHistory', JSON.stringify(history))
        localStorage.setItem('ganttBoardHistoryIndex', historyIndex)

        // NEW: keep URL shareable
        encodeStateToUrl();

        updateUndoRedoButtons();
    }

    function updateUndoRedoButtons() {
        document.getElementById('undoBtn').disabled = historyIndex <= 0;
        document.getElementById('redoBtn').disabled = historyIndex >= history.length - 1;
    }

    function undo() {
        if (historyIndex > 0) {
            historyIndex--;
            data = JSON.parse(JSON.stringify(history[historyIndex]));
            renderGantt();
            renderTaskTemplates();
            updateSummary();
            updateUndoRedoButtons();
        }
    }

    function redo() {
        if (historyIndex < history.length - 1) {
            historyIndex++;
            data = JSON.parse(JSON.stringify(history[historyIndex]));
            renderGantt();
            renderTaskTemplates();
            updateSummary();
            updateUndoRedoButtons();
        }
    }

    function exportToCsv() {
        const weeks = data.weeks;

        // Header row: Person, W1..Wn
        const headers = ['Person', ...Array.from({length: weeks}, (_, i) => `W${i + 1}`)];

        // CSV escaping per RFC 4180
        const csvEscape = (v) => {
            const s = String(v ?? '');
            const normalized = s.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
            return /[",\n]/.test(normalized) ? `"${normalized.replace(/"/g, '""')}"` : normalized;
        };

        const rows = [];
        rows.push(headers.map(csvEscape).join(','));

        data.people.forEach((person, pIdx) => {
            const row = [person];
            for (let w = 0; w < weeks; w++) {
                const names = [
                    ...new Set(
                        data.assignments
                            .filter(a => a.person === pIdx && w >= a.startWeek && w < a.startWeek + a.duration)
                            .map(a => a.name)
                    )
                ];
                row.push(names.join(' + ')); // flattened names only
            }
            rows.push(row.map(csvEscape).join(','));
        });

        const csvContent = '\ufeff' + rows.join('\r\n'); // UTF-8 BOM + CRLF
        const blob = new Blob([csvContent], {type: 'text/csv;charset=utf-8'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `gantt-assignments-${new Date().toISOString().split('T')[0]}.csv`;
        a.click();
        URL.revokeObjectURL(url);
    }

    function updateStartDate() {
        const dateInput = document.getElementById('startDateInput').value;
        data.startDate = dateInput ? new Date(dateInput) : null;
        renderGantt();
    }

    function getWeekDateRange(weekIndex) {
        if (!data.startDate) return `W${weekIndex}`;

        const weekStart = new Date(data.startDate);
        weekStart.setDate(weekStart.getDate() + (weekIndex * 7));

        const weekEnd = new Date(weekStart);
        weekEnd.setDate(weekStart.getDate() + 6);

        const formatDate = (date) => {
            const day = date.getDate();
            const month = date.getMonth() + 1;
            return `${day}.${month.toString().padStart(2, '0')}`;
        };

        return `W${weekIndex} (${formatDate(weekStart)}-${formatDate(weekEnd)})`;
    }


    //********************** MAIN INIT **********************//

    function initializeBoard() {
        saveState(); // Save initial state
        renderGantt();
        renderTaskTemplates();
        renderColorPicker();
        renderEditColorPicker()
        updateSummary();
        setupContextMenu();
    }

    function setupContextMenu() {
        // Hide context menu on click outside
        document.addEventListener('click', () => {
            document.getElementById('contextMenu').classList.remove('active');
        });

        // Prevent default right-click menu
        document.addEventListener('contextmenu', (e) => {
            if (e.target.closest('.week-cell')) {
                e.preventDefault();
            }
        });
    }

    function showContextMenu(e, person, week) {
        e.preventDefault();
        const menu = document.getElementById('contextMenu');

        menu.style.left = e.pageX + 'px';
        menu.style.top = e.pageY + 'px';
        menu.classList.add('active');

        contextMenuTarget = {person, week};

        // Check if paste is available
        const pasteItem = menu.querySelector('.context-menu-item:nth-child(2)');
        if (clipboard) {
            pasteItem.classList.remove('disabled');
        } else {
            pasteItem.classList.add('disabled');
        }
    }

    function contextMenuCopy() {
        if (!contextMenuTarget) return;

        // Find assignments at this position
        const assignments = data.assignments.filter(a =>
            a.person === contextMenuTarget.person &&
            contextMenuTarget.week >= a.startWeek &&
            contextMenuTarget.week < a.startWeek + a.duration
        );

        if (assignments.length > 0) {
            clipboard = assignments.map(a => ({
                name: a.name,
                duration: 1, // Copy single week
                category: a.category,
                color: a.color,
                partial: a.partial,
                excludedFromCalculations: a.excludedFromCalculations
            }));
        }

        document.getElementById('contextMenu').classList.remove('active');
    }

    function contextMenuPaste() {
        if (!contextMenuTarget || !clipboard) return;

        clipboard.forEach(item => {
            data.assignments.push({
                name: item.name,
                person: contextMenuTarget.person,
                startWeek: contextMenuTarget.week,
                duration: item.duration,
                category: item.category,
                color: item.color,
                partial: item.partial,
                excludedFromCalculations: item.excludedFromCalculations
            });
        });

        saveState();
        renderGantt();
        renderTaskTemplates();
        updateSummary();
        document.getElementById('contextMenu').classList.remove('active');
    }

    function contextMenuDelete() {
        if (!contextMenuTarget) return;

        // Find and remove assignments at this position
        const toDelete = [];
        data.assignments.forEach((a, idx) => {
            if (a.person === contextMenuTarget.person &&
                contextMenuTarget.week >= a.startWeek &&
                contextMenuTarget.week < a.startWeek + a.duration) {

                // If multi-week assignment, split it
                if (a.duration > 1) {
                    const weekToDelete = contextMenuTarget.week - a.startWeek;

                    if (weekToDelete === 0) {
                        // Delete first week
                        a.startWeek++;
                        a.duration--;
                    } else if (weekToDelete === a.duration - 1) {
                        // Delete last week
                        a.duration--;
                    } else {
                        // Split in the middle
                        const secondPart = {
                            ...a,
                            startWeek: contextMenuTarget.week + 1,
                            duration: a.duration - weekToDelete - 1
                        };
                        a.duration = weekToDelete;
                        data.assignments.push(secondPart);
                    }
                } else {
                    toDelete.push(idx);
                }
            }
        });

        // Remove single-week assignments
        toDelete.sort((a, b) => b - a).forEach(idx => {
            data.assignments.splice(idx, 1);
        });

        saveState();
        renderGantt();
        updateSummary();
        document.getElementById('contextMenu').classList.remove('active');
    }

    function getUsedWeeksForTemplate(templateName) {
        const usedWeeks = new Set();
        data.assignments.forEach(a => {
            if (a.name === templateName && a.weekNum) {
                usedWeeks.add(a.weekNum);
            }
        });

        // sum all weeks used by assignments with this template name
        const allDurations = data.assignments.filter(a => a.name === templateName).map(a => a.duration).reduce((a, b) => a + b, 0);

        for (let w = 0; w < allDurations; w++) {
            usedWeeks.add(w + 1); // +1 to match weekNum starting from 1
        }
        return usedWeeks;
    }

    function computeDisplayedEffort(assignment) {
        const ownWeight = assignment.partial ? 0.5 : 1;
        let total = 0;
        const start = assignment.startWeek;
        const end = start + assignment.duration; // exclusive

        for (let w = start; w < end; w++) {
            const overlaps = data.assignments.filter(a =>
                a.person === assignment.person &&
                w >= a.startWeek &&
                w < a.startWeek + a.duration
            );
            const share = ownWeight / Math.max(1, overlaps.length);
            total += share;
        }
        return total;
    }


    function renderGantt() {
        const headerRow = document.getElementById('headerRow');
        const ganttBody = document.getElementById('ganttBody');

        // Clear existing
        while (headerRow.children.length > 1) {
            headerRow.removeChild(headerRow.lastChild);
        }
        ganttBody.innerHTML = '';

        // Add week headers
        for (let w = 0; w < data.weeks; w++) {
            const th = document.createElement('th');
            th.textContent = getWeekDateRange(w);
            th.style.fontSize = data.startDate ? '11px' : '12px';
          //  th.textContent = `W${w}`;
            headerRow.appendChild(th);
        }

        // Add people rows
        data.people.forEach((person, personIdx) => {
            const row = document.createElement('tr');
            const nameCell = document.createElement('td');
            nameCell.innerHTML = `${person} <button class="delete" onclick="removePerson(${personIdx})" style="float: right; padding: 2px 6px; font-size: 10px;">×</button>`;
            row.appendChild(nameCell);

            for (let w = 0; w < data.weeks; w++) {
                const cell = document.createElement('td');
                cell.className = 'week-cell';
                cell.dataset.person = personIdx;
                cell.dataset.week = w;

                // Add context menu
                cell.oncontextmenu = (e) => showContextMenu(e, personIdx, w, cell);

                cell.ondragover = handleDragOver;
                cell.ondrop = handleDrop;
                cell.ondragleave = handleDragLeave;

                // Create stack container
                const stackDiv = document.createElement('div');
                stackDiv.className = 'week-cell-stack';
                cell.appendChild(stackDiv);

                row.appendChild(cell);
            }

            ganttBody.appendChild(row);
        });

        function resizeBlockHandler(e, assignment, block, row) {
            e.stopPropagation();
            e.preventDefault();
            const startX = e.clientX;
            const startDuration = assignment.duration;
            const cellWidth = row.scrollWidth;

            // Create preview element
            const preview = document.createElement('div');
            preview.className = 'resize-preview';
            preview.style.left = block.style.left;
            preview.style.width = `${assignment.duration * block.scrollWidth}px`;
            preview.style.height = `20px`;
            preview.style.color = `#000`;
            row.appendChild(preview);

            console.log(preview)
            block.classList.add('resizing');

            const onMouseMove = (e) => {
                const deltaX = e.clientX - startX;
                const newWeeks = Math.max(1, Math.round(startDuration + deltaX / cellWidth));

                if (assignment.startWeek + newWeeks <= data.weeks) {
                    preview.style.width = `${newWeeks * cellWidth}px`;
                }
            };

            const onMouseUp = (e) => {
                const deltaX = e.clientX - startX;
                const newWeeks = Math.max(1, Math.round(startDuration + deltaX / cellWidth));

                if (assignment.startWeek + newWeeks <= data.weeks && newWeeks !== startDuration) {
                    assignment.duration = newWeeks;
                 //   console.log(assignment.duration);
                    saveState();
                    renderGantt();
                    renderTaskTemplates();
                    updateSummary();
                }

                preview.remove();
                block.classList.remove('resizing');
                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);
            };

            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);
        };


        // Render single-week assignments
        const singleWeekAssignments = data.assignments.filter(a => a.duration > 0);
        const cellAssignments = {};

        singleWeekAssignments.forEach((assignment, idx) => {
            const realIdx = data.assignments.indexOf(assignment);
            const key = `${assignment.person}-${assignment.startWeek}`;
            if (!cellAssignments[key]) {
                cellAssignments[key] = [];
            }
            cellAssignments[key].push({assignment, idx: realIdx});
        });

        // Render stacked single-week assignments
        Object.entries(cellAssignments).forEach(([key, assignments]) => {
            const [person, week] = key.split('-').map(Number);
            const cell = document.querySelector(`.week-cell[data-person="${person}"][data-week="${week}"]`);
            if (!cell) return;

            const stackDiv = cell.querySelector('.week-cell-stack');
            const stackCount = assignments.length;

            assignments.forEach(({assignment, idx}) => {
                const block = document.createElement('div');
                block.className = 'task-block single-week';

                if (assignment.excludedFromCalculations) {
                    block.classList.add('excluded');
                }

                const row = ganttBody.children[assignment.person];
                if (!row) return;

                const startCell = row.children[assignment.startWeek];
                if (!startCell) return;

                const fractionalEffort = assignment.partial ? 0.5 / stackCount : 1 / stackCount;

                block.style.backgroundColor = assignment.color;
                block.draggable = true;
                block.dataset.assignmentIdx = idx;
                block.style.width = `${assignment.duration * stackDiv.scrollWidth}px`;
                block.style.height = `${30 / stackCount}px`;
                block.style.left = `${stackDiv.offsetLeft}px`;
                block.style.top = `${stackDiv.offsetTop + 15 * stackDiv.children.length}px`;

                //here we need to account that cellAssignments entries may have variable lengths from a single to multiple cells ,
                const effort = computeDisplayedEffort(assignment);
                const effortText = `${effort.toFixed(2)}w`;

                block.innerHTML = `
                        <span class="task-name">[${assignment.category}] - ${assignment.name} ${assignment.excludedFromCalculations ? '🚫Excluded' : ''} </span>
                        <span class="task-info">${effortText}</span>
                         <div class="resize-handle"></div>
                    `;

                // Drag handlers
                block.ondragstart = (e) => {
                    draggedElement = block;
                    draggedData = {type: 'assignment', idx: idx};
                    block.classList.add('dragging');
                };

                block.ondragend = (e) => {
                    block.classList.remove('dragging');
                    draggedElement = null;
                    draggedData = null;
                };


                // Double click to remove
                block.ondblclick = () => removeAssignment(idx);

                stackDiv.appendChild(block);

                // Improved resize handler
                const resizeHandle = block.querySelector('.resize-handle');
                resizeHandle.onmousedown = (e) => resizeBlockHandler(e, assignment, block, stackDiv);
            });
        });
    }

    function renderTaskTemplates() {
        const container = document.getElementById('taskTemplates');
        container.innerHTML = '';

        data.taskTemplates.forEach((template, idx) => {
            const div = document.createElement('div');
            div.className = 'task-template';
            div.style.borderLeft = `4px solid ${template.color}`;

            const mode = document.getElementById('modeSelect').value;
            const usedWeeks = getUsedWeeksForTemplate(template.name);

            if (mode === 'granular') {
                // Granular mode - show individual week blocks
                div.innerHTML = `
                        <div class="task-template-header">
                            <div>

                                <div class="task-template-name">${template.name} / <span style="color: #6a898f; font-size: 16px;">${template.category}</div>
                                <div class="task-template-info">
                                    <input type="number" value="${template.duration}" min="1" step="1"
                                           onchange="updateTemplateDuration(${idx}, this.value)"
                                           onclick="event.stopPropagation()">
                                    weeks ${template.excludedFromCalculations ? '<span style="color: #7f8c8d; font-size: 11px; margin-left: 8px;">(🚫Excluded</span>)' : ''} </span>
                                </div>
                            </div>




                            <button class="rename-btn" onclick="openRenameModal(${idx})">Edit✏️</button>
                            <div class="delete-icon" onclick="removeTaskTemplate(${idx})">×</div>

                        </div>
                        <div class="week-blocks" id="weeks-${template.id}"></div>
                    `;

                // Make whole template draggable
                div.draggable = true;
                div.ondragstart = (e) => {
                    if (e.target.classList.contains('week-block') ||
                        e.target.classList.contains('delete-icon') ||
                        e.target.tagName === 'INPUT') {
                        return;
                    }

                    const weeksUsed = div.querySelectorAll(`#weeks-${template.id} .used`);
                    const nextUnusedWeekIndex = weeksUsed.length + 1

                    draggedElement = div;
                    draggedData = {
                        type: 'week',
                        template: template,
                        weekNum: nextUnusedWeekIndex
                    };
                    div.classList.add('dragging');
                };

                div.ondragend = (e) => {
                    div.classList.remove('dragging');
                    draggedElement = null;
                    draggedData = null;
                };

                // Add week blocks
                const weekContainer = div.querySelector(`#weeks-${template.id}`);
                for (let w = 1; w <= template.duration; w++) {
                    const weekBlock = document.createElement('div');
                    weekBlock.className = 'week-block';
                    if (usedWeeks.has(w)) {
                        weekBlock.classList.add('used');
                    }
                    weekBlock.style.backgroundColor = template.color;
                    weekBlock.textContent = `W${w}`;
                    weekBlock.draggable = !usedWeeks.has(w);

                    if (!usedWeeks.has(w)) {
                        weekBlock.ondragstart = (e) => {
                            e.stopPropagation();
                            draggedElement = weekBlock;
                            draggedData = {
                                type: 'week',
                                template: template,
                                weekNum: w
                            };
                            weekBlock.classList.add('dragging');
                        };

                        weekBlock.ondragend = (e) => {
                            weekBlock.classList.remove('dragging');
                            draggedElement = null;
                            draggedData = null;
                        };
                    }

                    weekContainer.appendChild(weekBlock);
                }

                // Highlight on hover
                div.onmouseenter = () => {
                    highlightTaskAssignments(template.name);
                };

                div.onmouseleave = () => {
                    clearHighlights();
                };

            }

            container.appendChild(div);
        });
    }

    function updateTemplateDuration(idx, newDuration) {
        const duration = parseInt(newDuration);
        if (duration > 0) {
            data.taskTemplates[idx].duration = duration;
            saveState();
            renderTaskTemplates();
            updateSummary();
        }
    }

    function highlightTaskAssignments(taskName) {
        // Clear previous highlights
        clearHighlights();

        // Highlight all cells with this task
        data.assignments.forEach(assignment => {
            if (assignment.name === taskName) {
                for (let w = 0; w < assignment.duration; w++) {
                    const cell = document.querySelector(
                        `.week-cell[data-person="${assignment.person}"][data-week="${assignment.startWeek + w}"]`
                    );
                    if (cell) {
                        cell.classList.add('highlight');
                    }
                }
            }
        });
    }

    function clearHighlights() {
        document.querySelectorAll('.week-cell.highlight').forEach(cell => {
            cell.classList.remove('highlight');
        });
    }

    function handleDragOver(e) {
        e.preventDefault();
        e.currentTarget.classList.add('drag-over');
    }

    function handleDragLeave(e) {
        e.currentTarget.classList.remove('drag-over');
    }

    function handleDrop(e) {
        e.preventDefault();
        e.currentTarget.classList.remove('drag-over');

        const person = parseInt(e.currentTarget.dataset.person);
        const week = parseInt(e.currentTarget.dataset.week);

        if (draggedData.type === 'template') {
            // Add continuous assignment
            const assignment = {
                name: draggedData.template.name,
                person: person,
                startWeek: week,
                duration: draggedData.template.duration,
                category: draggedData.template.category,
                color: draggedData.template.color,
                partial: false,
                excludedFromCalculations: draggedData.template.excludedFromCalculations || false
            };

            if (week + assignment.duration <= data.weeks) {
                data.assignments.push(assignment);
                saveState();
                renderGantt();
                updateSummary();
            }
        } else if (draggedData.type === 'week') {
            // Add single week assignment
            const assignment = {
                name: draggedData.template.name,
                person: person,
                startWeek: week,
                duration: 1,
                category: draggedData.template.category,
                color: draggedData.template.color,
                partial: false,
                weekNum: draggedData.weekNum,
                excludedFromCalculations: draggedData.template.excludedFromCalculations
            };

            data.assignments.push(assignment);
            saveState();
            renderGantt();
            renderTaskTemplates(); // Update to show used weeks
            updateSummary();
        } else if (draggedData.type === 'assignment') {
            // Move existing assignment
            const assignment = data.assignments[draggedData.idx];
            if (week + assignment.duration <= data.weeks) {
                assignment.person = person;
                assignment.startWeek = week;
                saveState();
                renderGantt();
                updateSummary();
            }
        }
    }

    function updateSummary() {
        const summaryContainer = document.getElementById('summary');
        summaryContainer.innerHTML = '';

        // Calculate person utilization with fractional assignments
        const personUtilization = {};
        data.people.forEach((person, idx) => {
            personUtilization[idx] = 0;
        });

        // Calculate task totals with fractional contributions
        const taskTotals = {};

        // Calculate category totals with fractional contributions
        const categoryTotals = {};

        // Calculate week-by-week utilization and task contributions
        for (let person = 0; person < data.people.length; person++) {
            for (let week = 0; week < data.weeks; week++) {
                const assignmentsInCell = data.assignments.filter(a =>
                    a.person === person &&
                    week >= a.startWeek &&
                    week < a.startWeek + a.duration &&
                    !a.excludedFromCalculations
                );

                if (assignmentsInCell.length > 0) {
                    // Calculate fractional effort for each assignment in this cell
                    assignmentsInCell.forEach(assignment => {
                        const fractionalEffort = (assignment.partial ? 0.5 : 1) / assignmentsInCell.length;

                        // Add to person utilization
                        personUtilization[person] += fractionalEffort;

                        // Add to task totals
                        if (!taskTotals[assignment.name]) {
                            taskTotals[assignment.name] = {allocated: 0, budget: 0};
                        }
                        taskTotals[assignment.name].allocated += fractionalEffort;


                        // Category totals
                        const cat = assignment.category || 'Uncategorized';
                        if (!categoryTotals[cat]) {
                            categoryTotals[cat] = {allocated: 0, budget: 0};
                        }
                        categoryTotals[cat].allocated += fractionalEffort;
                    });
                }
            }
        }

        // Match with templates for budget
        Object.keys(taskTotals).forEach(taskName => {
            const template = data.taskTemplates.find(t => t.name === taskName);
            if (template) {
                taskTotals[taskName].budget = template.duration;
            }
        });

        // Build category budgets by summing template durations per category
        data.taskTemplates.forEach(t => {
            if (!t.excludedFromCalculations) {
                const cat = t.category || 'Uncategorized';
                if (!categoryTotals[cat]) {
                    categoryTotals[cat] = {allocated: 0, budget: 0};
                }
                categoryTotals[cat].budget += t.duration;
            }
        });

        // Person summary
        const personSummaryDiv = document.createElement('div');
        personSummaryDiv.className = 'summary-item';
        personSummaryDiv.innerHTML = '<strong>Person Utilization</strong>';

        data.people.forEach((person, idx) => {
            const utilization = personUtilization[idx];
            const percentage = (utilization / data.weeks * 100).toFixed(1);
            const capacityDiv = document.createElement('div');
            capacityDiv.className = 'person-capacity';
            capacityDiv.innerHTML = `
                    <span>${person}</span>
                    <span>${utilization.toFixed(2)}/${data.weeks}w (${percentage}%)</span>
                `;
            personSummaryDiv.appendChild(capacityDiv);
        });

        summaryContainer.appendChild(personSummaryDiv);

        // Task summary
        const taskSummaryDiv = document.createElement('div');
        taskSummaryDiv.className = 'summary-item';

        let hasIssues = false;
        Object.entries(taskTotals).forEach(([taskName, totals]) => {
            if (Math.abs(totals.allocated - totals.budget) > 0.01 && totals.budget > 0) {
                hasIssues = true;
                taskSummaryDiv.className = 'summary-item warning';
            }
        });

        taskSummaryDiv.innerHTML = '<strong>Task Allocation</strong>';

        Object.entries(taskTotals).forEach(([taskName, totals]) => {
            const taskDiv = document.createElement('div');
            taskDiv.className = 'person-capacity';
            let status = '';
            if (totals.budget > 0) {
                if (Math.abs(totals.allocated - totals.budget) < 0.01) {
                    status = '✓';
                } else if (totals.allocated > totals.budget) {
                    status = '⚠️ Over';
                    taskDiv.style.color = '#e74c3c';
                } else {
                    status = '⚠️ Under';
                    taskDiv.style.color = '#f39c12';
                }
            }
            taskDiv.innerHTML = `
                    <span>${taskName}</span>
                    <span>${totals.allocated.toFixed(2)}/${totals.budget || '?'}w ${status}</span>
                `;
            taskSummaryDiv.appendChild(taskDiv);
        });

        summaryContainer.appendChild(taskSummaryDiv);


        // Category summary (right next to task summary)
        const categorySummaryDiv = document.createElement('div');
        categorySummaryDiv.className = 'summary-item';

        let catHasIssues = false;
        Object.entries(categoryTotals).forEach(([, totals]) => {
            if (totals.budget > 0 && Math.abs(totals.allocated - totals.budget) > 0.01) {
                catHasIssues = true;
            }
        });
        if (catHasIssues) categorySummaryDiv.classList.add('warning');

        categorySummaryDiv.innerHTML = '<strong>Category Allocation</strong>';

        Object.entries(categoryTotals).forEach(([catName, totals]) => {
            const catDiv = document.createElement('div');
            catDiv.className = 'person-capacity';
            let status = '';
            if (totals.budget > 0) {
                if (Math.abs(totals.allocated - totals.budget) < 0.01) {
                    status = '✓';
                } else if (totals.allocated > totals.budget) {
                    status = '⚠️ Over';
                    catDiv.style.color = '#e74c3c';
                } else {
                    status = '⚠️ Under';
                    catDiv.style.color = '#f39c12';
                }
            }
            catDiv.innerHTML = `
            <span>${catName}</span>
            <span>${totals.allocated.toFixed(2)}/${totals.budget || '?'}w ${status}</span>
        `;
            categorySummaryDiv.appendChild(catDiv);
        });
        summaryContainer.appendChild(categorySummaryDiv);


        // Total summary
        const totalSummaryDiv = document.createElement('div');
        totalSummaryDiv.className = 'summary-item';
        const totalAllocated = Object.values(personUtilization).reduce((a, b) => a + b, 0);
        const totalCapacity = data.people.length * data.weeks;
        const totalPercentage = (totalAllocated / totalCapacity * 100).toFixed(1);

        totalSummaryDiv.innerHTML = `
                <strong>Total Capacity</strong>
                <div class="person-capacity">
                    <span>Used</span>
                    <span>${totalAllocated.toFixed(2)}/${totalCapacity}w (${totalPercentage}%)</span>
                </div>
            `;

        summaryContainer.appendChild(totalSummaryDiv);
    }

    function addPerson() {
        const name = prompt('Enter person name:');
        if (name) {
            data.people.push(name);
            saveState();
            renderGantt();
            updateSummary();
        }
    }

    function removePerson(idx) {
        if (confirm(`Remove ${data.people[idx]}?`)) {
            data.people.splice(idx, 1);
            data.assignments = data.assignments.filter(a => a.person !== idx);
            data.assignments.forEach(a => {
                if (a.person > idx) a.person--;
            });
            saveState();
            renderGantt();
            updateSummary();
        }
    }

    function removeAssignment(idx) {
        data.assignments.splice(idx, 1);
        saveState();
        renderGantt();
        renderTaskTemplates();
        updateSummary();
    }

    function addTaskTemplate() {
        document.getElementById('taskModal').classList.add('active');
    }

    function closeModal() {
        document.getElementById('taskModal').classList.remove('active');
    }

    function saveTaskTemplate() {
        const name = document.getElementById('taskName').value;
        const duration = parseFloat(document.getElementById('taskDuration').value);
        const category = document.getElementById('taskCategory').value || 'General';
        const excludedFromCalculations = document.getElementById('taskExcluded').checked;


        if (name && duration) {
            data.taskTemplates.push({
                id: Date.now(),
                name: name,
                duration: duration,
                category: category,
                color: selectedColor,
                excludedFromCalculations: excludedFromCalculations
            });

            saveState();
            renderTaskTemplates();
            closeModal();

            // Clear form
            document.getElementById('taskName').value = '';
            document.getElementById('taskDuration').value = '1';
            document.getElementById('taskCategory').value = '';
        }
    }

    // Rename functions
    function openRenameModal(idx) {
        const template = data.taskTemplates[idx];
        if (!template) return;

        renameTemplateIdx = idx;
        document.getElementById('renameName').value = template.name;
        document.getElementById('renameCategory').value = template.category;
        document.getElementById('renameExcluded').checked = template.excludedFromCalculations || false;
        document.getElementById('renameModal').classList.add('active');
    }

    function closeRenameModal() {
        document.getElementById('renameModal').classList.remove('active');
        renameTemplateIdx = null;
    }

    function confirmEdit() {
        if (renameTemplateIdx === null) return;

        const template = data.taskTemplates[renameTemplateIdx];
        const oldName = template.name;
        const oldCategory = template.category;
        const newName = document.getElementById('renameName').value.trim();
        const newCategory = document.getElementById('renameCategory').value.trim();
        const excludedFromCalculations = document.getElementById('renameExcluded').checked;

        if (!newName) {
            alert('Task name cannot be empty');
            return;
        }

        // Update template
        template.name = newName;
        template.category = newCategory || 'General';
        template.excludedFromCalculations = excludedFromCalculations || false;
        template.color = selectedEditColor || template.color;

        // Update all assignments with this template
        data.assignments.forEach(assignment => {
            if (assignment.name === oldName) {
                assignment.name = newName;
                assignment.category = template.category;
                assignment.excludedFromCalculations = excludedFromCalculations;
                assignment.color = template.color;
            }
        });

        closeRenameModal();
        saveState();
        renderGantt();
        renderTaskTemplates();
        updateSummary();
    }

    function removeTaskTemplate(idx) {
        const template = data.taskTemplates[idx];
        if (!template) return;
        if (confirm(`Remove ${template.name}? All assignments using this template will also be removed!`)) {
            // Remove all assignments related to this template (match by name)
            data.assignments = data.assignments.filter(a => a.name !== template.name);

            data.taskTemplates.splice(idx, 1);

            saveState();
            renderGantt();
            renderTaskTemplates();
            updateSummary();
        }
    }

    function renderColorPicker() {
        const picker = document.getElementById('colorPicker');
        picker.innerHTML = '';

        colors.forEach(color => {
            const div = document.createElement('div');
            div.className = 'color-option';
            if (color === selectedColor) {
                div.classList.add('selected');
            }
            div.style.backgroundColor = color;
            div.onclick = () => {
                selectedColor = color;
                renderColorPicker();
            };
            picker.appendChild(div);
        });
    }

    function renderEditColorPicker() {
        const picker = document.getElementById('colorPickerEdit');
        picker.innerHTML = '';

        colors.forEach(color => {
            const div = document.createElement('div');
            div.className = 'color-option';
            if (color === selectedEditColor) {
                div.classList.add('selected');
            }
            div.style.backgroundColor = color;
            div.onclick = () => {
                selectedEditColor = color;
                renderEditColorPicker();
            };
            picker.appendChild(div);
        });
    }

    function optimizeGantt() {
        alert('Optimize Gantt functionality will be implemented soon!');
        // Placeholder for smart optimization algorithm
    }

    function clearBoard() {
        if (confirm('Clear all assignments? Templates and people will remain.')) {
            data.assignments = [];
            saveState();
            renderGantt();
            renderTaskTemplates();
            updateSummary();
        }
    }

    function changeWeeks() {
        const weeks = parseInt(document.getElementById('weeksInput').value);
        if (weeks > 0 && weeks <= 52) {
            data.weeks = weeks;
            saveState();
            renderGantt();
            updateSummary();
        }
    }

    function saveProject() {
        const dataStr = JSON.stringify(data, null, 2);
        const blob = new Blob([dataStr], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `gantt-project-${new Date().toISOString().split('T')[0]}.json`;
        a.click();
        URL.revokeObjectURL(url);
    }

    function loadProject() {
        document.getElementById('fileInput').click();
    }

    function handleFileLoad(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    data = JSON.parse(e.target.result);
                    saveState();
                    renderGantt();
                    renderTaskTemplates();
                    updateSummary();
                    document.getElementById('weeksInput').value = data.weeks;
                } catch (err) {
                    alert('Invalid project file');
                }
            };
            reader.readAsText(file);
        }
    }

    function changeMode() {
        const mode = document.getElementById('modeSelect').value;
        data.mode = mode;
        renderTaskTemplates();
    }

    // Initialize
    // Check for saved data on load
    const savedData = localStorage.getItem('ganttBoardData');
    if (savedData) {
        try {
            data = JSON.parse(savedData);
            const savedHistory = localStorage.getItem('ganttBoardHistory');
            const savedHistoryIndex = localStorage.getItem('ganttBoardHistoryIndex');

            if (savedHistory) {
                history = JSON.parse(savedHistory);
            }

            if (savedHistoryIndex) {
                historyIndex = parseInt(savedHistoryIndex);
            }

            document.getElementById('weeksInput').value = data.weeks;
            updateUndoRedoButtons();
        } catch (e) {
            console.error('Failed to load saved data:', e);
        }
    }

    // If URL carries a state, prefer it over localStorage
    const urlStateDecoded = decodeStateFromUrl();
    if (urlStateDecoded) {
        console.log(urlStateDecoded);
        data = urlStateDecoded;
        history = [];
        historyIndex = -1;

        document.getElementById('startDateInput').value = (data.startDate || '' ).toString().split('T')[0];
        document.getElementById('weeksInput').value = data.weeks;

        updateUndoRedoButtons();
    }

    initializeBoard();
</script>
</body>
</html>